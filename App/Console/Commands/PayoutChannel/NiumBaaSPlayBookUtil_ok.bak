<?php

namespace App\Console\Commands\PayoutChannel;

use DOMDocument;
use DOMXPath;
use Illuminate\Console\Command;

class NiumBaaSPlayBookUtil extends Command
{
    /**
     * The name and signature of the console command.
     *
     * @var string
     */
    protected $signature = 'nium-baas-playbook:util
                {--mode=""}';

    /**
     * The console command description.
     *
     * @var string
     */
    protected $description = '';

    public function __construct()
    {
        parent::__construct();
    }

    public function handle()
    {
        $country_infos = $this->_getCountryInfor();
        $country_infos = [
            // "india" => "https://playbook.nium.com/country/india?pm_relation=payout_methods",
            // "algeria" => "https://playbook.nium.com/country/algeria?pm_relation=payout_methods"
            // "albania" => "https://playbook.nium.com/country/albania?pm_relation=payout_methods"
            // "united-states-of-america" => "https://playbook.nium.com/country/united-states-of-america?pm_relation=payout_methods"
            // "mexico" => "https://playbook.nium.com/country/mexico?pm_relation=payout_methods"
            // "andorra" => "https://playbook.nium.com/country/andorra?pm_relation=payout_methods"
            // "angola" => "https://playbook.nium.com/country/angola?pm_relation=payout_methods"
            // "anguilla" => "https://playbook.nium.com/country/anguilla?pm_relation=payout_methods"
            // "antigua" => "https://playbook.nium.com/country/antigua?pm_relation=payout_methods"
            // "argentina" => "https://playbook.nium.com/country/argentina?pm_relation=payout_methods"
            // "armenia" => "https://playbook.nium.com/country/armenia?pm_relation=payout_methods"
            // "aruba" => "https://playbook.nium.com/country/aruba?pm_relation=payout_methods"
            // "australia" => "https://playbook.nium.com/country/australia?pm_relation=payout_methods"
            // "austria" => "https://playbook.nium.com/country/austria?pm_relation=payout_methods"
            // "azerbaijan" => "https://playbook.nium.com/country/azerbaijan?pm_relation=payout_methods"
            // "bahamas" => "https://playbook.nium.com/country/bahamas?pm_relation=payout_methods"
            // "bahrain" => "https://playbook.nium.com/country/bahrain?pm_relation=payout_methods"
            // "bangladesh" => "https://playbook.nium.com/country/bangladesh?pm_relation=payout_methods"
            // "belgium" => "https://playbook.nium.com/country/belgium?pm_relation=payout_methods"
            // "belize" => "https://playbook.nium.com/country/belize?pm_relation=payout_methods"
            // "benin" => "https://playbook.nium.com/country/benin?pm_relation=payout_methods"
            // "bermuda" => "https://playbook.nium.com/country/bermuda?pm_relation=payout_methods"
            // "bhutan" => "https://playbook.nium.com/country/bhutan?pm_relation=payout_methods"
            // "bolivia" => "https://playbook.nium.com/country/bolivia?pm_relation=payout_methods"
            // "botswana" => "https://playbook.nium.com/country/botswana?pm_relation=payout_methods"
            'brazil' => 'https://playbook.nium.com/country/brazil?pm_relation=payout_methods',
            // "brunei" => "https://playbook.nium.com/country/brunei?pm_relation=payout_methods"
            // "bulgaria" => "https://playbook.nium.com/country/bulgaria?pm_relation=payout_methods"
            // "burkina-faso" => "https://playbook.nium.com/country/burkina-faso?pm_relation=payout_methods"
            // "burundi" => "https://playbook.nium.com/country/burundi?pm_relation=payout_methods"
            // "cambodia" => "https://playbook.nium.com/country/cambodia?pm_relation=payout_methods"
            "cameroon" => "https://playbook.nium.com/country/cameroon?pm_relation=payout_methods"
            // "canada" => "https://playbook.nium.com/country/canada?pm_relation=payout_methods"
            // "cape-verde" => "https://playbook.nium.com/country/cape-verde?pm_relation=payout_methods"
            // "central-african-republic" => "https://playbook.nium.com/country/central-african-republic?pm_relation=payout_methods"
            // "chad" => "https://playbook.nium.com/country/chad?pm_relation=payout_methods"
            // "chile" => "https://playbook.nium.com/country/chile?pm_relation=payout_methods"
            // "china" => "https://playbook.nium.com/country/china?pm_relation=payout_methods"
            // "colombia" => "https://playbook.nium.com/country/colombia?pm_relation=payout_methods"
            // "comoros" => "https://playbook.nium.com/country/comoros?pm_relation=payout_methods"
            // "costa-rica" => "https://playbook.nium.com/country/costa-rica?pm_relation=payout_methods"
            // "croatia-hrvatska" => "https://playbook.nium.com/country/croatia-hrvatska?pm_relation=payout_methods"
            // "cyprus" => "https://playbook.nium.com/country/cyprus?pm_relation=payout_methods"
            // "czech-republic" => "https://playbook.nium.com/country/czech-republic?pm_relation=payout_methods"
            // "denmark" => "https://playbook.nium.com/country/denmark?pm_relation=payout_methods"
            // "djibouti" => "https://playbook.nium.com/country/djibouti?pm_relation=payout_methods"
            // "dominica" => "https://playbook.nium.com/country/dominica?pm_relation=payout_methods"
            // "dominican-republic" => "https://playbook.nium.com/country/dominican-republic?pm_relation=payout_methods"
            // "east-timor" => "https://playbook.nium.com/country/east-timor?pm_relation=payout_methods"
            // "ecuador" => "https://playbook.nium.com/country/ecuador?pm_relation=payout_methods"
            // "egypt" => "https://playbook.nium.com/country/egypt?pm_relation=payout_methods"
            // "el-salvador" => "https://playbook.nium.com/country/el-salvador?pm_relation=payout_methods"
            // "equatorial-guinea" => "https://playbook.nium.com/country/equatorial-guinea?pm_relation=payout_methods"
            // "eritrea" => "https://playbook.nium.com/country/eritrea?pm_relation=payout_methods"
            // "estonia" => "https://playbook.nium.com/country/estonia?pm_relation=payout_methods"
            // "ethiopia" => "https://playbook.nium.com/country/ethiopia?pm_relation=payout_methods"
            // "fiji" => "https://playbook.nium.com/country/fiji?pm_relation=payout_methods"
            // "finland" => "https://playbook.nium.com/country/finland?pm_relation=payout_methods"
            // "france" => "https://playbook.nium.com/country/france?pm_relation=payout_methods"
            // "gabon" => "https://playbook.nium.com/country/gabon?pm_relation=payout_methods"
            // "gambia" => "https://playbook.nium.com/country/gambia?pm_relation=payout_methods"
            // "georgia" => "https://playbook.nium.com/country/georgia?pm_relation=payout_methods"
            // "germany" => "https://playbook.nium.com/country/germany?pm_relation=payout_methods"
            // "ghana" => "https://playbook.nium.com/country/ghana?pm_relation=payout_methods"
            // "greece" => "https://playbook.nium.com/country/greece?pm_relation=payout_methods"
            // "grenada" => "https://playbook.nium.com/country/grenada?pm_relation=payout_methods"
            // "guam" => "https://playbook.nium.com/country/guam?pm_relation=payout_methods"
            // "guatemala" => "https://playbook.nium.com/country/guatemala?pm_relation=payout_methods"
            // "guyana" => "https://playbook.nium.com/country/guyana?pm_relation=payout_methods"
            // "honduras" => "https://playbook.nium.com/country/honduras?pm_relation=payout_methods"
            // "hong-kong" => "https://playbook.nium.com/country/hong-kong?pm_relation=payout_methods"
            // "hungary" => "https://playbook.nium.com/country/hungary?pm_relation=payout_methods"
            // "iceland" => "https://playbook.nium.com/country/iceland?pm_relation=payout_methods"
            // "indonesia" => "https://playbook.nium.com/country/indonesia?pm_relation=payout_methods"
            // "ireland" => "https://playbook.nium.com/country/ireland?pm_relation=payout_methods"
            // "israel" => "https://playbook.nium.com/country/israel?pm_relation=payout_methods"
            // "italy" => "https://playbook.nium.com/country/italy?pm_relation=payout_methods"
            // "ivory-coast" => "https://playbook.nium.com/country/ivory-coast?pm_relation=payout_methods"
            // "japan" => "https://playbook.nium.com/country/japan?pm_relation=payout_methods"
            // "jordan" => "https://playbook.nium.com/country/jordan?pm_relation=payout_methods"
            // "kazakhstan" => "https://playbook.nium.com/country/kazakhstan?pm_relation=payout_methods"
            // "kenya" => "https://playbook.nium.com/country/kenya?pm_relation=payout_methods"
            // "kosovo" => "https://playbook.nium.com/country/kosovo?pm_relation=payout_methods"
            // "kuwait" => "https://playbook.nium.com/country/kuwait?pm_relation=payout_methods"
            // "kyrgyzstan" => "https://playbook.nium.com/country/kyrgyzstan?pm_relation=payout_methods"
            // "laos" => "https://playbook.nium.com/country/laos?pm_relation=payout_methods"
            // "latvia" => "https://playbook.nium.com/country/latvia?pm_relation=payout_methods"
            // "lesotho" => "https://playbook.nium.com/country/lesotho?pm_relation=payout_methods"
            // "liberia" => "https://playbook.nium.com/country/liberia?pm_relation=payout_methods"
            // "liechtenstein" => "https://playbook.nium.com/country/liechtenstein?pm_relation=payout_methods"
            // "lithuania" => "https://playbook.nium.com/country/lithuania?pm_relation=payout_methods"
            // "luxembourg" => "https://playbook.nium.com/country/luxembourg?pm_relation=payout_methods"
            // "macao" => "https://playbook.nium.com/country/macao?pm_relation=payout_methods"
            // "macedonia" => "https://playbook.nium.com/country/macedonia?pm_relation=payout_methods"
            // "madagascar" => "https://playbook.nium.com/country/madagascar?pm_relation=payout_methods"
            // "malawi" => "https://playbook.nium.com/country/malawi?pm_relation=payout_methods"
            // "malaysia" => "https://playbook.nium.com/country/malaysia?pm_relation=payout_methods"
            // "maldives" => "https://playbook.nium.com/country/maldives?pm_relation=payout_methods"
            // "malta" => "https://playbook.nium.com/country/malta?pm_relation=payout_methods"
            // "mauritania" => "https://playbook.nium.com/country/mauritania?pm_relation=payout_methods"
            // "mauritius" => "https://playbook.nium.com/country/mauritius?pm_relation=payout_methods"
            // "moldova" => "https://playbook.nium.com/country/moldova?pm_relation=payout_methods"
            // "monaco" => "https://playbook.nium.com/country/monaco?pm_relation=payout_methods"
            // "mongolia" => "https://playbook.nium.com/country/mongolia?pm_relation=payout_methods"
            // "montenegro" => "https://playbook.nium.com/country/montenegro?pm_relation=payout_methods"
            // "morocco" => "https://playbook.nium.com/country/morocco?pm_relation=payout_methods"
            // "mozambique" => "https://playbook.nium.com/country/mozambique?pm_relation=payout_methods"
            // "namibia" => "https://playbook.nium.com/country/namibia?pm_relation=payout_methods"
            // "nepal" => "https://playbook.nium.com/country/nepal?pm_relation=payout_methods"
            // "netherlands" => "https://playbook.nium.com/country/netherlands?pm_relation=payout_methods"
            // "new-zealand" => "https://playbook.nium.com/country/new-zealand?pm_relation=payout_methods"
            // "niger" => "https://playbook.nium.com/country/niger?pm_relation=payout_methods"
            // "nigeria" => "https://playbook.nium.com/country/nigeria?pm_relation=payout_methods"
            // "norway" => "https://playbook.nium.com/country/norway?pm_relation=payout_methods"
            // "oman" => "https://playbook.nium.com/country/oman?pm_relation=payout_methods"
            // "pakistan" => "https://playbook.nium.com/country/pakistan?pm_relation=payout_methods"
            // "palau" => "https://playbook.nium.com/country/palau?pm_relation=payout_methods"
            // "palestine" => "https://playbook.nium.com/country/palestine?pm_relation=payout_methods"
            // "papua-new-guinea" => "https://playbook.nium.com/country/papua-new-guinea?pm_relation=payout_methods"
            // "paraguay" => "https://playbook.nium.com/country/paraguay?pm_relation=payout_methods"
            // "peru" => "https://playbook.nium.com/country/peru?pm_relation=payout_methods"
            // "philippines" => "https://playbook.nium.com/country/philippines?pm_relation=payout_methods"
            // "poland" => "https://playbook.nium.com/country/poland?pm_relation=payout_methods"
            // "portugal" => "https://playbook.nium.com/country/portugal?pm_relation=payout_methods"
            // "puerto-rico" => "https://playbook.nium.com/country/puerto-rico?pm_relation=payout_methods"
            // "qatar" => "https://playbook.nium.com/country/qatar?pm_relation=payout_methods"
            // "republic-of-the-congo" => "https://playbook.nium.com/country/republic-of-the-congo?pm_relation=payout_methods"
            // "romania" => "https://playbook.nium.com/country/romania?pm_relation=payout_methods"
            // "rwanda" => "https://playbook.nium.com/country/rwanda?pm_relation=payout_methods"
            // "san-marino" => "https://playbook.nium.com/country/san-marino?pm_relation=payout_methods"
            // "saudi-arabia" => "https://playbook.nium.com/country/saudi-arabia?pm_relation=payout_methods"
            // "senegal" => "https://playbook.nium.com/country/senegal?pm_relation=payout_methods"
            // "serbia" => "https://playbook.nium.com/country/serbia?pm_relation=payout_methods"
            // "seychelles" => "https://playbook.nium.com/country/seychelles?pm_relation=payout_methods"
            // "sierra-leone" => "https://playbook.nium.com/country/sierra-leone?pm_relation=payout_methods"
            // "singapore" => "https://playbook.nium.com/country/singapore?pm_relation=payout_methods"
            // "slovakia" => "https://playbook.nium.com/country/slovakia?pm_relation=payout_methods"
            // "slovenia" => "https://playbook.nium.com/country/slovenia?pm_relation=payout_methods"
            // "south-africa" => "https://playbook.nium.com/country/south-africa?pm_relation=payout_methods"
            // "south-korea" => "https://playbook.nium.com/country/south-korea?pm_relation=payout_methods"
            // "spain" => "https://playbook.nium.com/country/spain?pm_relation=payout_methods"
            // "sri-lanka" => "https://playbook.nium.com/country/sri-lanka?pm_relation=payout_methods"
            // "suriname" => "https://playbook.nium.com/country/suriname?pm_relation=payout_methods"
            // "swaziland" => "https://playbook.nium.com/country/swaziland?pm_relation=payout_methods"
            // "sweden" => "https://playbook.nium.com/country/sweden?pm_relation=payout_methods"
            // "switzerland" => "https://playbook.nium.com/country/switzerland?pm_relation=payout_methods"
            // "taiwan" => "https://playbook.nium.com/country/taiwan?pm_relation=payout_methods"
            // "tajikistan" => "https://playbook.nium.com/country/tajikistan?pm_relation=payout_methods"
            // "tanzania" => "https://playbook.nium.com/country/tanzania?pm_relation=payout_methods"
            // "thailand" => "https://playbook.nium.com/country/thailand?pm_relation=payout_methods"
            // "togo" => "https://playbook.nium.com/country/togo?pm_relation=payout_methods"
            // "tonga" => "https://playbook.nium.com/country/tonga?pm_relation=payout_methods"
            // "tunisia" => "https://playbook.nium.com/country/tunisia?pm_relation=payout_methods"
            // "turkey" => "https://playbook.nium.com/country/turkey?pm_relation=payout_methods"
            // "turkmenistan" => "https://playbook.nium.com/country/turkmenistan?pm_relation=payout_methods"
            // "tuvalu" => "https://playbook.nium.com/country/tuvalu?pm_relation=payout_methods"
            // "uganda" => "https://playbook.nium.com/country/uganda?pm_relation=payout_methods"
            // "united-arab-emirates" => "https://playbook.nium.com/country/united-arab-emirates?pm_relation=payout_methods"
            // "united-kingdom" => "https://playbook.nium.com/country/united-kingdom?pm_relation=payout_methods"
            // "uruguay" => "https://playbook.nium.com/country/uruguay?pm_relation=payout_methods"
            // "uzbekistan" => "https://playbook.nium.com/country/uzbekistan?pm_relation=payout_methods"
            // "vatican-city-state" => "https://playbook.nium.com/country/vatican-city-state?pm_relation=payout_methods"
            // "vietnam" => "https://playbook.nium.com/country/vietnam?pm_relation=payout_methods"
            // "zambia" => "https://playbook.nium.com/country/zambia?pm_relation=payout_methods"
        ];
        // $country_infos = [
        //     // 'vietnam' => 'https://playbook.nium.com/country/vietnam?pm_relation=payout_methods',
        //     "japan" => "https://playbook.nium.com/country/japan?pm_relation=payout_methods"
        // ];

        // 初始化 DOMDocument
        $dom = new DOMDocument();

        $this->info('# of countries: '.count($country_infos));

        foreach ($country_infos as $country => $url) {
            $filename = 'txn_limit_'.$country.'.json';
            if (file_exists($filename)) {
                unlink($filename);
            }

            // 載入網頁內容
            $country_html = file_get_contents($url);

            // 設置 DOMDocument 的 HTML 內容
            $dom->loadHTML($country_html, LIBXML_NOERROR);

            // 初始化 DOMXPath
            $xpath = new DOMXPath($dom);

            // 初始化陣列
            $result = [];

            // 查詢表頭和資料行
            $buttons = $xpath->query("//h3[contains(@id,'accordion-collapse-heading')]");

            if ($buttons->length > 0) {
                foreach ($buttons as $button) {
                    $heading_id = $button->getAttribute('id');  // accordion-collapse-heading-79
                    $currency_dom_text = $xpath->query("//h3[@id='$heading_id']//small[@class='text-gray-500 font-normal normal']/text()[1]");
                    $currency = trim($currency_dom_text->item(0)->textContent);

                    $headingId_pattern = '/accordion-collapse-heading-(\d+)/';
                    // echo "$heading_id".PHP_EOL;
                    if (preg_match($headingId_pattern, $heading_id, $matches)) {
                        $payouts_details_table = $xpath->query("//h3[@id='$heading_id']//span[@class='payouts-details-table']");
                        if (null != $payouts_details_table->item(0)) {
                            $payout_method = trim($payouts_details_table->item(0)->firstChild->textContent);
                        } else {
                            $this->warn("payout method not found in $country.");
                        }

                        $bodyId = 'accordion-collapse-body-'.$matches[1];
                        // $accordionBody = $dom->getElementById($bodyId);  // accordion-collapse-body-79
                        $title = 'Transaction limit per end-user';
                        $contains_title = $xpath->query("//h3[@id='$bodyId']//div[@id='$bodyId']//dt[text()='$title']");
                        if (!$contains_title && null != $payout_method) {
                            continue;
                        }

                        // Compose associate array
                        // "Bank Account (ACH)" => [
                        //     B2B => ["2000 VND","VND 500 Mn* per transaction. (*Documents may be asked by bank for transaction amount > 250 Mn VND)"],
                        //     B2C => ["2000 VND","VND 500 Mn* per transaction. (*Documents may be asked by bank for transaction amount > 250 Mn VND)"],
                        //     P2P => ["2000 VND","VND 500 Mn* per transaction. (*Documents may be asked by bank for transaction amount > 250 Mn VND)"],
                        // ]

                        $table = $xpath->query("//div[@id='$bodyId']//table")->item(0);
                        // 如果找到了表格元素
                        if (null !== $table) {
                            $header = [];
                            // 選擇header
                            $headerRow = $xpath->query('.//thead/tr/th', $table);

                            // 遍歷標題行元素，將其文本添加到表頭數組中
                            foreach ($headerRow as $h_idx => $header) {
                                if (0 == $h_idx) {
                                    continue;
                                }

                                // 選擇body
                                $bodyRaw = $xpath->query('.//tbody/tr', $table);  // 2個tr
                                $bodyRawLength = $bodyRaw->length;

                                $limit = [];
                                // 遍歷資料行元素
                                foreach ($bodyRaw as $b_idx => $row) {   // parse 2個tr
                                    if (1 == $bodyRawLength) {
                                        // 選擇行中的所有儲存格元素
                                        $cell_node_list = $xpath->query("./th[position()=$h_idx+1]", $row);

                                        $limit[] = 'Max:'.trim($cell_node_list->item(0)->textContent);
                                    }

                                    if (2 == $bodyRawLength) {
                                        $type_node = $xpath->query("./th[position()=1]", $row);

                                        // 選擇行中的所有儲存格元素
                                        $cell_node_list = $xpath->query("./th[position()=$h_idx+1]", $row);

                                        // echo('Type '.trim($type_node_list->item(0)->textContent))."\n";
                                        // echo('Min/Max '.trim($cell_node_list->item(0)->textContent))."\n";
                                        // if ('B2C' == trim($header->nodeValue)) {
                                        //     echo 'Type: '.trim($type_node_list->item(0)->textContent)."\n";
                                        //     echo 'Cell '.trim($cell_node_list->item(0)->textContent)."\n";
                                        //     break;
                                        // }

                                        if ('Min' == trim($type_node->item(0)->textContent)) {
                                            $limit[] = 'Min:'.trim($cell_node_list->item(0)->textContent);
                                        }else{
                                        // if ('Max' == trim($type_node_list->item(0)->textContent)){
                                            $limit[] = 'Max:'.trim($cell_node_list->item(0)->textContent);
                                        }

                                        // if ('' != trim($type_node_list->item(0)->textContent)) {
                                        //     $limit[] = trim($type_node_list->item(0)->textContent).':'.trim($cell_node_list->item(0)->textContent);
                                        // }
                                    }
                                }
                                $result[$country][$payout_method]['currency'] = $currency;
                                $result[$country][$payout_method][trim($header->nodeValue)] = $limit;
                            }
                        }
                    }
                }
                // dd($result);

                // Write data to file
                file_put_contents($filename, json_encode($result));
                echo "file generated：$filename\n";
            }
        }

        return 0;
    }

    private function _getCountryInfor()
    {
        $site_url = 'https://playbook.nium.com/?pm_relation=payout_methods';

        // 初始化 DOMDocument
        $dom = new DOMDocument();

        libxml_use_internal_errors(true);

        // 載入網頁內容
        $html = file_get_contents($site_url);

        // 設置 DOMDocument 的 HTML 內容
        $dom->loadHTML($html);

        // 初始化 DOMXPath
        $xpath = new DOMXPath($dom);

        // 定義查詢國家列表的 XPath
        $xpathQuery = "//*[@class='min-w-0 flex-1']/a";

        // 查詢結果
        $countryNodes = $xpath->query($xpathQuery);

        // $countryArray = iterator_to_array($countryNodes);

        // 儲存國家列表
        $countryList = [];

        // 提取國家列表內容
        foreach ($countryNodes as $node) {
            $data = $node->getAttribute('x-data');
            // 定义正则表达式模式
            $pattern = '/url:\s*[`\'"](https?:\/\/[^`\'"]+)[`\'"]/';

            // 进行匹配
            preg_match($pattern, $data, $url_matches);

            // 提取匹配到的 URL
            $url = isset($url_matches[1]) ? $url_matches[1] : null;

            // 使用正则表达式匹配 / 和 ? 之间的部分
            preg_match('/\/([^\/?]+)\?/', $url, $country_matches);

            // 提取匹配到的部分
            $countryName = isset($country_matches[1]) ? $country_matches[1] : '';

            if (null != $url) {
                $countryList[$countryName] = $url;
            }
        }

        // 輸出國家列表
        // foreach ($countryList as $country_url) {
        //     echo $country_url."\n";
        // }

        return $countryList;
    }
}
